FROM node:22-bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

# Install git (needed because one dependency is fetched via git),
# plus certs + ssh client (common for git+ssh or https)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git openssh-client ca-certificates bash curl \
 && rm -rf /var/lib/apt/lists/*

# Install systemd + your original deps in ONE layer (apt-get update must be same RUN)
RUN apt-get update && apt-get install -y --no-install-recommends \
    systemd systemd-sysv dbus dbus-user-session \
    git openssh-client ca-certificates bash curl \
 && rm -rf /var/lib/apt/lists/*

# Pin OpenClaw version for reproducible builds
RUN npm install -g openclaw@2026.2.3-1

# Persist OpenClaw state/config
WORKDIR /data

EXPOSE 18789

COPY start.sh /usr/local/bin/start-openclaw
RUN chmod +x /usr/local/bin/start-openclaw

# "Enable" the service without systemctl (works during docker build)
RUN mkdir -p /etc/systemd/system/multi-user.target.wants \
 && ln -sf /etc/systemd/system/openclaw-gateway.service \
          /etc/systemd/system/multi-user.target.wants/openclaw-gateway.service

STOPSIGNAL SIGRTMIN+3
CMD ["/sbin/init"]

